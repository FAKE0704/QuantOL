name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  # Job 1: 部署后端（公开仓库）
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout backend
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 8086
          debug: true
          script: |
            echo "Connection successful!"
            whoami
            pwd
            ls -la

      - name: Deploy backend to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 8086
          script: |
            cd /home/user0704/QuantOL
            bash scripts/deploy/deploy-backend.sh

  # Job 2: 部署前端（私有仓库）
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend (private)
        uses: actions/checkout@v4
        with:
          repository: FAKE0704/QuantOL-frontend
          token: ${{ secrets.GH_TOKEN }}
          ref: main
          persist-credentials: false

      - name: Deploy frontend to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 8086
          debug: true
          script: |
            cd /home/user0704/QuantOL
            bash scripts/deploy/deploy-frontend.sh
